<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="discussion.css">
    <title>Discussion Page</title>
</head>

<body onload="renderContent()">
<!-- <body> -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand" href="#">Current Discussion Name</span>
            <div class="navbar-modified" id="navbarText">
                <ul class="navbar-nav me-auto mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="select-discussion.html">Home</a>
                    </li>
                </ul>
                <form action="/logout">
                    <button type="logout" class="btn logout">Logout</button>
                </form>
            </div>
        </div>
    </nav>
    <div id="create-new-window">
        <div class="header" id="create-new-header"></div>
        <div id="enter-below"></div>
        <input type="text" id="name" placeholder="">
        <div class="buttons">
            <button type="button" class="btn btn-secondary" id="close-btn" onclick="closeWindow()">Cancel</button>
            <button type="button" class="btn btn-primary" id="create-btn"></button>
        </div>
    </div>
    <div class="container-fluid" id="disable">
        <div class="row">
            <div class="channels-users col-lg-2 col-md-3 col-sm-4 col-4">
                <div class="header channels">
                    <span class="navbar-brand">Channels</span>
                    <span class="new-channel-btn navbar-brand" onclick="toggleNewChannel()">+</span>
                </div>
                <div id="channel-select">
                    <div class="channel" onclick="chooseChannel(this)">
                        <span class="channel-name">Channel 1</span>
                        <img class="settings-icon" src="./img/settings_icon.svg" onclick="toggleDeleteChannel(this.parent)">
                    </div>
                </div>
                <div class="header users">
                    <span class="navbar-brand">Users</span>
                    <span class="new-channel-btn navbar-brand" onclick="toggleNewUser()">+</span>
                </div>
                <div id="users-select">
                </div>
            </div>
            <div class="discussion col-lg-10 col-md-9 col-sm-8 col-8">
                <input class="text-box" type="text" onkeypress="sendMessage();" placeholder="Type your message here...">
                <div class="text-box-background"></div>
                <div id="messages">
                </div>

            </div>
        </div>
    </div>
    
    <script>
        var channel_data = {}; 
        var active_channel = 0;
        
        function renderContent(){
            renderChannels();
            active_channel = channel_data[0].id;
            renderMessages();    
        }

        function isAlphaNumeric(str) {
            var code, i, len;
            let empty = true;
            for (i = 0, len = str.length; i < len; i++) {
                code = str.charCodeAt(i);
                if (code != 32) {
                    empty = false;
                }
                if (!(code > 47 && code < 58) && // numeric (0-9)
                    !(code > 64 && code < 91) && // upper alpha (A-Z)
                    !(code > 96 && code < 123) && // lower alpha (a-z)
                    !(code == 32)) { // space
                        return false;
                }
            }
            return !(empty);
        };

        function toggleNewChannel(){
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            new_channel_window.style.display = "flex";
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Create New Channel";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Enter the name of the new channel below:";
            var name = document.getElementById("name");
            name.style.display = "inline-block";
            name.value = "";
            name.placeholder = "Channel Name";
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Create Channel";
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            create_btn.onclick = function() {newChannel()};
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function toggleDeleteChannel(button){
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Delete Channel";
            var enter_below = document.getElementById("enter-below");
            channelName = button.parentNode.childNodes[0].innerHTML;
            enter_below.innerHTML = "Are you sure you want to delete the channel " + channelName + "?";
            var name = document.getElementById("name");
            name.style.display = "none";
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Delete Channel";
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            create_btn.onclick = function() {deleteChannel(channelName)};
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function toggleNewUser(){
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Add New User";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Enter the email of the new user below:";
            var name = document.getElementById("name");
            name.style.display = "inline-block";
            name.value = "";
            name.placeholder = "email";
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Add User";
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            create_btn.onclick = function() {newUser()};
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function closeWindow(){
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "none";
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "1";
            disable_content.style.pointerEvents = "auto";
        }

        function accessDenied(){
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Access Denied";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Only admins of the board can perform this action.";
            var name = document.getElementById("name");
            name.style.display = "none";
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "none";
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Close";
        }

        function errorAddingUser(errorString){
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Error Adding User";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = errorString;
            var name = document.getElementById("name");
            name.style.display = "none";
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "none";
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Close";
        }

        function newUser(){
            var userName = document.getElementById("name").value;
            if (userName != null && userName != "") {
                // Check if user name already exists
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                        console.log(this.responseText);
                        if (this.responseText == "TRUE") {
                            //add user to board
                            renderUsers();
                        }
                        else if (this.responseText == "Access Denied"){
                            // alert("You do not have permission to add a user");
                            accessDenied();
                        }
                        else if (this.responseText == "Multiple Account with Email"){
                            errorAddingUser("A user with this email already exists.");
                        }
                        else if (this.responseText == "Invalid Email"){
                            errorAddingUser("Invalid email.");
                        }
                        else{
                            console.log(this.responseText);
                        }
                    }
                }
                xhr_fetch.open('POST', '/add-member', false);
                xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr_fetch.send('board_id='+board_id+'&new_member_email='+userName);
            }
            else{
                alert("Invalid username");
            }
        }

        function renderUsers(){
            var users = document.getElementById("users-select");
            var newUser = document.createElement("div");
            newUser.className = "user";
            newUser.innerHTML = "<span>" + userName + "</span><img class=\"settings-icon\" src=\"./img/settings_icon.svg\" onclick=\"toggleDeleteUser(this.parent)\">";
            users.appendChild(newUser);
            closeWindow();
        }

        function chooseChannel(channel){
            var channelName = channel.childNodes[0].innerHTML;
            active_channel = channel_data.find(x => x.name === channelName).id;
            renderMessages();
        }

        //THIS IS THE AJAX TO CREATE A CHANNEL
        var board_id = '77';
        function newChannel(){
            var channelName = document.getElementById("name").value;
            if (channelName != null && channelName != "" && isAlphaNumeric(channelName)) {

                var xhr_create = new XMLHttpRequest();
                xhr_create.onreadystatechange = function() {
                    if(xhr_create.readyState == 4 && xhr_create.status == 200) {
                        if(this.responseText == "TRUE") {
                            renderChannels();   
                            closeWindow();
                        }
                        else if (this.responseText == "Access Denied"){
                            // alert("You do not have permission to create a channel");
                            accessDenied();
                        }
                        else{
                            alert("Error creating channel");
                        }
                    }
                }
                xhr_create.open('POST', '/create-channel', false);
                xhr_create.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_create.send('boardId='+board_id+'&name='+channelName);
            }
            else{
                alert("Invalid channel name");
            }
        }

        function deleteChannel(channelName){
            var xhr_delete = new XMLHttpRequest();
            xhr_delete.onreadystatechange = function() {
                if(xhr_delete.readyState == 4 && xhr_delete.status == 200) {
                    if(this.responseText == "TRUE") {
                        active_channel = channel_data[0].id;
                        renderChannels();  
                        renderMessages();    
                        closeWindow();
                    }
                    else if(this.responseText == "Access Denied"){
                        // alert("You do not have permission to delete this channel");
                        accessDenied();
                    }
                    else{
                        alert("Error deleting channel");
                    }
                }
            }
            xhr_delete.open('POST', '/delete-channel', false);
            xhr_delete.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            channel_id = channel_data.find(x => x.name === channelName).id;
            // channel_id = '5';
            xhr_delete.send('channel_id='+channel_id);
        }
                
        function renderChannels(){
            // To be changed to the board id (should not be static)
            var board_id = '77';

            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                    // DO/CALL YOUR RENDER FROM IN HERE
                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    channel_data = parsed_data;
                    var channels = document.getElementById("channel-select");
                    channels.innerHTML = "";
                    for (var i = 0; i < parsed_data.length; i++) {
                        var newChannel = document.createElement("div");
                        newChannel.className = "channel";
                        newChannel.onclick = function() {chooseChannel(this)};
                        newChannel.innerHTML = "<span class=\"channel-name\">" + parsed_data[i].name + "</span> <img class=\"settings-icon\" src=\"./img/settings_icon.svg\" onclick=\"toggleDeleteChannel(this)\">";
                        channels.appendChild(newChannel);
                    }
                }
            }
            xhr_fetch.open('POST', '/fetch-channels-list', false);
            xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr_fetch.send('boardId='+board_id);
        }
        
        // test function to add messages to the discussion
        function sendMessage() {
            var key = window.event.keyCode;
            if (key === 13 && document.getElementsByClassName("text-box")[0].value != "") {
                // Getting required elements
                var message = document.getElementsByClassName("text-box")[0].value;
                
                var xhr_create = new XMLHttpRequest();
                xhr_create.onreadystatechange = function() {
                    if(xhr_create.readyState == 4 && xhr_create.status == 200) {
                        if(this.responseText == "TRUE") {
                            // FETCH/RELOAD THE MESSAGE LIST HERE
                            renderMessages();
                        }
                    }
                }
                xhr_create.open('POST', '/create-message', false);
                xhr_create.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_create.send('channelId='+active_channel+'&message='+message);
            }
        }

        function renderMessages(){
            //THIS IS THE AJAX TO FETCH THE MESSAGES
        
            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                    // DO/CALL YOUR RENDER FROM IN HERE
                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    var messages = document.getElementById("messages");
                    messages.innerHTML = "";
                    for (var i = 0; i < parsed_data.length; i++) {
                        var newMessage = document.createElement("div");
                        newMessage.className = "message";
                        //creating the user html element
                        var user = document.createElement("div");
                        user.className = "username";
                        user.innerHTML = "<strong>" + parsed_data[i].username + "</strong>";
                        //creating the datetime html element
                        var time = document.createElement("div");
                        time.className = "datetime";
                        time.innerHTML = parsed_data[i].date;
                        //creating the text html element
                        var text = document.createElement("div");
                        text.className = "text";
                        text.innerHTML = parsed_data[i].message;
                        //adding user and text as children of newMessage
                        newMessage.appendChild(user);
                        newMessage.appendChild(time);
                        newMessage.appendChild(text);
                        //adding newMessage to messages
                        messages.appendChild(newMessage);
                    }
                    //clearing the text box
                    document.getElementsByClassName("text-box")[0].value = "";
                    //scrolling to bottom of messages
                    messages.scrollTo(0, 1000);
                }
            }
            xhr_fetch.open('POST', '/fetch-messages-list', false);
            xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr_fetch.send('channelId='+active_channel);
        }
        
    </script>
</body>