<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="discussion.css">
    <title>Discussion Thread - myThreads - McGill University</title>
    <link rel="icon" type="image/x-icon" href="./img/logo.ico">
</head>

<body onload="renderContent()">
    <!-- Bootstrap navbar template, with some modifications for responsiveness and additional buttons -->
    <nav class="navbar navbar-expand-lg banner" id="navbar">
        <div class="container-fluid">
            <img src="./img/logo.png" alt="logo" class="d-inline-block align-top" style="width:30px;height:30px;margin-right:15px;">
            <span class="navbar-brand" id="board-name" style="color:#ffffff;cursor:default;"></span>
            <ul class="navbar-nav me-auto mb-lg-0">
                <div class="nav navbar-left">
                    <a href="./select-discussion.html" class="boards-link" style="margin-left:15px;color:#ffffff;">Home</a>
                </div>
            </ul>
            <img src="./img/hamburger.svg" alt="" class="hamburger" onclick="toggleHamburgerMenu()">
            <div class="navbar-modified" id="navbarText">
                <div id="hamburger-buttons">
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" id="dropdown-button" type="button" onclick="togglePinnedMessages()" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="./img/pin_icon.svg" class="pin" style="padding-right: 6px; padding-bottom: 4px;">
                            Pinned
                        </button>
                        <div id="close-menu-overlay" onclick="togglePinnedMessages()"></div>
                        <div class="dropdown-menu" id="dropdown-menu">
                        
                        </div>
                    </div>
                        <button id="leaveBoard" class="btn leaveboard-btn" onclick="leaveBoard()" style="margin-right:15px;">Leave board</button>
                        <form action="./logout" method="post">
                            <button id="logout" type="logout" class="btn logout-btn">Logout</button>
                        </form>
                </div>
            </div>
        </div>
    </nav>
    <!-- This window will toggle when interacting with the page (Adding/deleting, confirmations, and error messages) -->
    <div id="create-new-window">
        <div class="header" id="create-new-header"></div>
        <div id="enter-below"></div>
        <input type="text" id="name" placeholder="">
        <small id="valid-input"></small>
        <div class="buttons">
            <button type="button" class="btn btn-secondary cancel-btn" id="close-btn" onclick="closeWindow()" style="margin-right:5px">Cancel</button>
            <button type="button" class="btn btn-primary" id="create-btn"></button>
        </div>
    </div>
    <!-- This container houses the majority of the content of the page, includes the mobile sidebar toggle button, sidebar, and messages -->
    <div class="container-fluid" id="disable">
        <div class="row">
            <div id="open-channels-users">
                <img id="arrow" src="./img/right_arrow.svg" alt="" onclick="openChannelsUsers()">
            </div>
            <div class="channels-users col-lg-2 col-md-3 col-sm-4 col-4" id="l-column">
                <div class="header channels l-col-headers">
                    <span class="navbar-brand" style="cursor:default">Channels</span>
                    <span class="new-channel-btn add-icon" onclick="toggleNewChannel()">&#43;</span>
                </div>
                <div id="channel-select">
                    <div class="channel" onclick="chooseChannel(this)">
                    </div>
                </div>
                <div class="header users l-col-headers">
                    <span class="navbar-brand" style="cursor:default">Users</span>
                    <span class="new-channel-btn add-icon" onclick="toggleNewUser()">&#43;</span>
                </div>
                <div id="users-select">
                </div>
            </div>
            <div class="discussion col-lg-10 col-md-9 col-sm-8 col-8">
                <input class="text-box" type="text" onkeypress="sendMessage();" placeholder="Type your message here...">
                <div class="text-box-background"></div>
                <div id="messages">
                    <div class="message">                    
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables for page data
        var channel_data = {}; 
        var user_data = {};
        var message_data = {};
        var active_channel = null;
        var active_channel_name = null;
        var board_id = '';
        var board_color = '';
        my_username = getUserEmail();
        var cur_is_admin = false;
        //extract the board name from the url
        const queryParams = new URLSearchParams(window.location.search);
        var board_name = queryParams.get('boardname');
        //if the board name is null, redirect to the select discussion page
        if (board_name == null){
            window.location.href = "./select-discussion.html";
        }
        document.getElementById("board-name").innerHTML = board_name;
        getBoardId(board_name);

        // Set interval to execute the function every second (1000 milliseconds)
        setInterval(checkForUpdates, 1000);

        function checkForUpdates(){

            function checkIfBoardDeleted(){
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                        parsed_data = JSON.parse(this.responseText);
                        for(var i = 0; i < parsed_data.length; i++){
                            if (parsed_data[i].id == board_id){
                                return;
                            }
                        }
                        //if the board was deleted, redirect to the select discussion page
                        error("Board Deleted", "Redirecting you to the home page.");
                        var create_btn = document.getElementById("create-btn");
                        create_btn.style.display = "none";
                        var close_btn = document.getElementById("close-btn");
                        close_btn.style.display = "none";
                        setInterval(function(){window.location.href = "./select-discussion.html";}, 3000);
                    }
                }
                xhr_fetch.open('GET', './fetch-board-list', true);  //asynchronous
                xhr_fetch.send();
            }

            function checkIfRemovedFromBoard(){
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                        parsed_data = JSON.parse(this.responseText);
                        test_name =  (JSON.stringify(my_username)).substring(14, (JSON.stringify(my_username)).length - 4)
                        if (!JSON.stringify(parsed_data).includes(test_name)){
                            //if the user was removed from the board, redirect to the select discussion page
                            error("Removed From Board", "Redirecting you to the home page.");
                            var create_btn = document.getElementById("create-btn");
                            create_btn.style.display = "none";
                            var close_btn = document.getElementById("close-btn");
                            close_btn.style.display = "none";
                            setInterval(function(){window.location.href = "./select-discussion.html";}, 3000);
                        }
                    }
                }
                xhr_fetch.open('POST', './fetch-board-users', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_fetch.send('boardId='+board_id);
            }

            function checkForChannelsUpdates(){
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                        //ticket not valid -> logout
                        if (this.responseText == "TICKET NOT VALID"){
                            window.location.href = './logout';
                        }

                        var response = JSON.parse(xhr_fetch.responseText);
                        if (!areJSONObjectsEqual(response, channel_data)){
                            renderChannels();
                        }
                    }
                }
                xhr_fetch.open('POST', './fetch-channels-list', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_fetch.send('boardId='+board_id);
            }
            function checkForUsersUpdates() {
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                        //ticket not valid -> logout
                        if (this.responseText == "TICKET NOT VALID"){
                            window.location.href = './logout';
                        }

                        var response = JSON.parse(xhr_fetch.responseText);
                        if (!areJSONObjectsEqual(response.users, user_data)){
                            renderUsers();
                        }
                    }
                }
                xhr_fetch.open('POST', './fetch-board-users', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                var params = "boardId="+board_id;
                xhr_fetch.send(params);
            }
            function checkForMessagesUpdates(){
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                        //ticket not valid -> logout
                        if (this.responseText == "TICKET NOT VALID"){
                            window.location.href = './logout';
                        }

                        var response = JSON.parse(xhr_fetch.responseText);
                        response.forEach(elm=> delete elm['is_pinned']);
                        var msg_data_without_pinned = JSON.parse(JSON.stringify(message_data));
                        msg_data_without_pinned.forEach(elm=> delete elm['is_pinned']);
                        if (!areJSONObjectsEqual(response, msg_data_without_pinned)){
                            renderMessages();
                            //scrolling to bottom of messages
                            messages.scrollTo(0, 1000);
                        }
                    }
                }
                xhr_fetch.open('POST', './fetch-messages-list', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_fetch.send('channelId='+active_channel);
            }
            function checkForPinnedMessagesUpdates(){
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                        //ticket not valid -> logout
                        if (this.responseText == "TICKET NOT VALID"){
                            window.location.href = './logout';
                        }

                        var response = JSON.parse(xhr_fetch.responseText);
                        if (!areJSONObjectsEqual(response, message_data)){
                            renderPinnedMessages();
                            renderMessages();
                        }
                    }
                }
                xhr_fetch.open('POST', './fetch-messages-list', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_fetch.send('channelId='+active_channel);
            }
            function areJSONObjectsEqual(obj1, obj2) {
                const jsonString1 = JSON.stringify(obj1);
                const jsonString2 = JSON.stringify(obj2);

                return jsonString1 === jsonString2;
            }
            checkIfBoardDeleted();
            checkIfRemovedFromBoard();
            checkForChannelsUpdates();
            checkForUsersUpdates();
            checkForMessagesUpdates();
            checkForPinnedMessagesUpdates();
        }
        
        // Scroll to an element, used when clicking on a pinned messages to jump to it.
        function scrollToElm(container, elm_id, duration){
            var elm = document.getElementById(elm_id);
            var pos = getRelativePos(elm);
            scrollTo( container, pos.top , duration);  // duration in seconds
            }

            function getRelativePos(elm){
            var pPos = elm.parentNode.getBoundingClientRect(), // parent pos
                cPos = elm.getBoundingClientRect(), // target pos
                pos = {};

            pos.top    = cPos.top    - pPos.top + elm.parentNode.scrollTop,
            pos.right  = cPos.right  - pPos.right,
            pos.bottom = cPos.bottom - pPos.bottom,
            pos.left   = cPos.left   - pPos.left;

            return pos;
        }
                
        function scrollTo(element, to, duration, onDone) {
            var start = element.scrollTop,
                change = to - start,
                startTime = performance.now(),
                val, now, elapsed, t;

            function animateScroll(){
                now = performance.now();
                elapsed = (now - startTime)/1000;
                t = (elapsed/duration);

                element.scrollTop = start + change * easeInOutQuad(t);

                if( t < 1 )
                    window.requestAnimationFrame(animateScroll);
                else
                    onDone && onDone();
            };

            animateScroll();
        };

        // helper function for smooth scrolling effect
        function easeInOutQuad(t){ return t<.5 ? 2*t*t : -1+(4-2*t)*t };

        //get board data from the server
        function getBoardId(board_name){

            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    for (var i = 0; i < parsed_data.length; i++) {
                        if (parsed_data[i].name == board_name){
                            board_id = parsed_data[i].id;
                            board_color = parsed_data[i].color;
                        }
                    }
                }
            }
            xhr_fetch.open('GET', './fetch-board-list', false);  // Set the third parameter to false for a synchronous request
            xhr_fetch.send();
        }

        function getUserEmail(){
            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }
                    my_username = this.responseText;
                }
            }
            xhr_fetch.open('POST', './fetch-user-email', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_fetch.send();
        }
        
        // render the content of the page onload
        function renderContent(){
            renderChannels();
            //if the board is new, create the general channel
            if (channel_data.length == 0){
                newChannel("General");
            }
            //set the active channel to the general channel and set its active background color
            active_channel = channel_data[0].id;
            channels = document.getElementsByClassName("channel");
            channels[0].style.backgroundColor = darkenColor(board_color, 60);
            //set the background color of the mobile sidebar button
            open_channels_user = document.getElementById("open-channels-users");
            open_channels_user.style.backgroundColor = darkenColor(board_color, 40);
            //render the messages of the active channel
            renderMessages();   
            renderPinnedMessages();  
            //render the users of the board
            renderUsers();
            //check if the user is an admin of the board and set the cur_is_admin variable accordingly
            is_admin();
            //set the color scheme of the board
            var navbar = document.getElementById("navbar");
            navbar.style.backgroundColor = board_color;
            var pinned_btn = document.getElementById("dropdown-button");
            pinned_btn.style.backgroundColor = darkenColor(board_color, 40);
            pinned_btn.style.borderColor = darkenColor(board_color, 30);
            pinned_btn.addEventListener('mouseover', function() {
                this.style.backgroundColor = darkenColor(board_color, 60);
                this.style.borderColor = darkenColor(board_color, 50);
            });
            pinned_btn.addEventListener('click', function() {
                this.style.backgroundColor = darkenColor(board_color, 60);
                this.style.borderColor = darkenColor(board_color, 50);
            });
            pinned_btn.addEventListener('mouseout', function() {
                this.style.backgroundColor = darkenColor(board_color, 40);
                this.style.borderColor = darkenColor(board_color, 30);
            });
            var l_col = document.getElementById("l-column");
            l_col.style.backgroundColor = darkenColor(board_color, 40);
            var l_col_headers = document.getElementsByClassName("l-col-headers");
            for (var i = 0; i < l_col_headers.length; i++) {
                l_col_headers[i].style.backgroundColor = darkenColor(board_color, 50);
            }
            var new_buttons = document.getElementsByClassName("new-channel-btn");
            for (var i = 0; i < new_buttons.length; i++) {
                new_buttons[i].addEventListener('mouseover', function() {
                    this.style.backgroundColor = darkenColor(board_color, 50);
                });
                new_buttons[i].addEventListener('mouseout', function() {
                    if (this.childNodes[0].innerHTML != active_channel_name){
                        this.style.backgroundColor = darkenColor(board_color, 50);
                    }
                });
            }
            leaveBoardBtn = document.getElementById("leaveBoard");
            leaveBoardBtn.style.backgroundColor = darkenColor(board_color, 40);
            leaveBoardBtn.style.borderColor = darkenColor(board_color, 30);
            //set the function of the leave/delete board menu depending on users admin status
            if (cur_is_admin){
                leaveBoardBtn.innerHTML = "Delete Board";
                leaveBoardBtn.onclick = function() {toggleDeleteBoard()};
            }
            else {
                leaveBoardBtn.innerHTML = "Leave Board";
                leaveBoardBtn.onclick = function() {toggleLeaveBoard()};
            }
            leaveBoardBtn.addEventListener('mouseover', function() {
                this.style.backgroundColor = "#e60000";
                this.style.borderColor = "#e60000";
            });
            leaveBoardBtn.addEventListener('mouseout', function() {
                this.style.backgroundColor = darkenColor(board_color, 40);
                this.style.borderColor = darkenColor(board_color, 30);
            });

            logoutBtn = document.getElementById("logout");
            logoutBtn.style.backgroundColor = darkenColor(board_color, 60);
            logoutBtn.style.borderColor = darkenColor(board_color, 50);
            logoutBtn.addEventListener('mouseover', function() {
                this.style.backgroundColor = "#cc0000";
                this.style.borderColor = "#cc0000";
            });
            logoutBtn.addEventListener('mouseout', function() {
                this.style.backgroundColor = darkenColor(board_color, 60);
                this.style.borderColor = darkenColor(board_color, 50);
            });
        }
        
        //A function to take a color and return a darkened version of it, this is used to create the standard color scheme for the board
        function darkenColor(hex, percentage) {
            // Convert hex to RGB
            const originalR = parseInt(hex.slice(1, 3), 16);
            const originalG = parseInt(hex.slice(3, 5), 16);
            const originalB = parseInt(hex.slice(5, 7), 16);

            // Darken the color
            const darkenedR = Math.round(originalR * (1 - percentage / 100));
            const darkenedG = Math.round(originalG * (1 - percentage / 100));
            const darkenedB = Math.round(originalB * (1 - percentage / 100));

            // Convert RGB back to hex
            const darkenedColor = `#${darkenedR.toString(16).padStart(2, '0')}${darkenedG.toString(16).padStart(2, '0')}${darkenedB.toString(16).padStart(2, '0')}`;
            return darkenedColor;
        }

        function isAlphaNumeric(str) {
            var code, i, len;
            let empty = true;
            for (i = 0, len = str.length; i < len; i++) {
                code = str.charCodeAt(i);
                if (code != 32) {
                    empty = false;
                }
                if (!(code > 47 && code < 58) && // numeric (0-9)
                    !(code > 64 && code < 91) && // upper alpha (A-Z)
                    !(code > 96 && code < 123) && // lower alpha (a-z)
                    !(code == 32)) { // space
                        return false;
                }
            }
            return !(empty);
        };

        function togglePinnedMessages(){
            var dropdown = document.getElementById("dropdown-menu");
            var overlay = document.getElementById("close-menu-overlay");
            if (dropdown.style.display != "block"){
                dropdown.style.display = "block";
                overlay.style.display = "block";
            }
            else{
                dropdown.style.display = "none";
                overlay.style.display = "none";
            }
        }

        //Call the server to update the message as pinned
        function pinMessage(pinButton){

            //Get the message id and its pinned status
            message = pinButton.parentNode;
            message_id = message.id;
            is_pinned = message.is_pinned;

            var xhr_update = new XMLHttpRequest();
            xhr_update.onreadystatechange = function() {
                if(xhr_update.readyState == 4 && xhr_update.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    var response = JSON.parse(xhr_update.responseText);
                    if (message.is_pinned == 1){
                        message.is_pinned = 0;
                        message.childNodes[3].style.display = "none";
                    }
                    else{
                        message.is_pinned = 1;
                        message.childNodes[3].style.display = "inline";
                    }
                    renderPinnedMessages();
                }
            }

            xhr_update.open('POST', './update-pinned-message', true); 
            xhr_update.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            var params = "message_id="+message_id+"&pinned_status="+is_pinned;
            xhr_update.send(params);
        }

        function renderPinnedMessages(){

            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                // If the messages were fetched successfully, render the messages column
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    // Parse the response data
                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    message_data = JSON.parse(JSON.stringify(parsed_data));
                    function sortByDate(jsonArray) {
                        // Sort the array based on the "date" field
                        jsonArray.sort((a, b) => {
                            const dateA = new Date(a.date);
                            const dateB = new Date(b.date);

                            return dateA - dateB;
                        });

                        return jsonArray;
                    }
                    parsed_data = sortByDate(parsed_data);
                    // Get the pinned messages dropdown column
                    pinned_messages = document.getElementById("dropdown-menu");
                    // Clear the pinned messages dropdown column
                    pinned_messages.innerHTML = "";
                    num_pinned = 0;
                    for (var i = 0; i < parsed_data.length; i++) {
                        if (parsed_data[i].is_pinned == 1){
                            num_pinned++;
                            //create the pinned message element
                            var pinned_message = document.createElement("div");
                            //set class name
                            pinned_message.className = "message mx-1";
                            pinned_message.onclick = function() {scrollToPinnedMessage(this.childNodes[4].innerHTML)};
                            //creating the user html element
                            var user = document.createElement("div");
                            user.className = "username";
                            var split_username = parsed_data[i].username.split("@");
                            user.innerHTML = "<strong>" + split_username[0] + "</strong>";
                            //creating the datetime html element
                            var time = document.createElement("div");
                            time.className = "datetime";
                            time.innerHTML = parsed_data[i].date;
                            //creating the text html element
                            var text = document.createElement("div");
                            text.className = "text";
                            text.innerHTML = parsed_data[i].message;
                            var pinned_id = document.createElement("p");
                            pinned_id.setAttribute("hidden", true);
                            pinned_id.innerHTML = parsed_data[i].id;
                            //create the pin message icon
                            var pin = document.createElement("img");
                            pin.className = "pin-icon unpin";
                            pin.src = "./img/pin_icon.svg";
                            //set the onclick function to scroll to the pinned message
                            pin.onclick = function() {
                                this.parentNode.onclick = null;
                                var pinned_message = document.getElementById(pinned_id.innerHTML);
                                pinMessage(pinned_message.childNodes[2]);
                                this.parentNode.onclick = function() {
                                    // referencing the innerHTML produced an error even though the assignment worked as intended, this is why the try catch is used
                                    try{
                                        scrollToPinnedMessage(this.childNodes[4].innerHTML);
                                    }
                                    catch(err){}
                                };
                            };
                            pinned_message.appendChild(user);
                            pinned_message.appendChild(time);
                            pinned_message.appendChild(pin);
                            pinned_message.appendChild(text);
                            pinned_message.appendChild(pinned_id);
                            pinned_messages.appendChild(pinned_message);
                        }
                    }
                    //if there are no pinned messages, display a message
                    if (num_pinned == 0){
                        var pinned_message = document.createElement("div");
                        pinned_message.className = "mx-1";
                        pinned_message.innerHTML = "<div class=\"text pinned-text\">No pinned messages</div>";
                        pinned_messages.appendChild(pinned_message);
                    }
                }
            }
            xhr_fetch.open('POST', './fetch-messages-list', false);
            xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr_fetch.send('channelId='+active_channel);
        }

        //This was created as a separate function as it did not work properly when called directly inside renderPinnedMessages()
        function scrollToPinnedMessage(pinned_id){
            var pinned_message = document.getElementById(pinned_id);
            var pinned_messages = document.getElementById("messages");
            scrollToElm(pinned_messages, pinned_id, 0.5);
        }

        //Open a window allowing to create a new channel
        function toggleNewChannel(){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Create New Channel";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Enter the name of the new channel below:";
            // Clear the input box and set its placeholder
            var name = document.getElementById("name");
            name.style.display = "inline-block";
            name.value = "";
            name.placeholder = "e.g., Announcements";
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            name.onchange = function() {
                if (channelNameExists(name.value)){
                    valid.innerHTML = "Channel name already exists";
                    document.getElementById("create-btn").disabled = true;
                }
                else{
                    valid.innerHTML = "";
                    document.getElementById("create-btn").disabled = false;
                }
            };
            // Change the create button to say "Create Channel" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Create Channel";
            create_btn.onclick = function() {newChannel(name.value)};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function channelNameExists(channelName){
            for (var i = 0; i < channel_data.length; i++) {
                if (channel_data[i].name == channelName){
                    return true;
                }
            }
            return false;
        }

        //Open a window allowing to delete a channel
        function toggleDeleteChannel(button){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Delete Channel";
            // Get the channel name from the button and display confirmation message
            var enter_below = document.getElementById("enter-below");
            channelName = button.parentNode.childNodes[0].innerHTML;
            enter_below.innerHTML = "Are you sure you want to delete the channel " + channelName + "?";
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Clear the message for duplicate additions
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            // Change the create button to say "Delete Channel" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Delete Channel";
            create_btn.onclick = function() {deleteChannel(channelName)};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        //Open a window allowing to add a new user
        function toggleNewUser(){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Add New User";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Enter the email of the new user below:";
            // Clear the input box and set its placeholder
            var name = document.getElementById("name");
            name.style.display = "inline-block";
            name.value = "";
            name.placeholder = "e.g., john.doe@mail.mcgill.ca";
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            name.onchange = function() {
                if (userExists(name.value)){
                    valid.innerHTML = "User already exists";
                    document.getElementById("create-btn").disabled = true;
                }
                else{
                    valid.innerHTML = "";
                    document.getElementById("create-btn").disabled = false;
                }
            };
            // Change the create button to say "Add User" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Add User";
            create_btn.onclick = function() {newUser()};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function userExists(userName){
            for (var i = 0; i < user_data.length; i++) {
                if (user_data[i] == userName){
                    return true;
                }
            }
            return false;
        }

        //Open a window allowing to delete a user
        function toggleDeleteUser(button){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Remove User From Board";
            // Get the user name from the button and display confirmation message
            var enter_below = document.getElementById("enter-below");
            userName = button.parentNode.childNodes[0].innerHTML;
            enter_below.innerHTML = "Are you sure you want to remove the user " + userName + "?";
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Clear the message for duplicate additions
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            // Change the create button to say "Remove User" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Remove User";
            create_btn.onclick = function() {deleteUser(userName)};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function toggleLeaveBoard(){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Leave Board?";
            // Get the user name from the button and display confirmation message
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Are you sure you want to leave this board?";
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Clear the message for duplicate additions
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            // Change the create button to say "Remove User" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Leave";
            create_btn.onclick = function() {leaveBoard()};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }
        

        function toggleDeleteBoard(){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Delete Board?";
            // Get the user name from the button and display confirmation message
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Are you sure you want to delete this board?";
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Clear the message for duplicate additions
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            // Change the create button to say "Remove User" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Delete";
            create_btn.onclick = function() {deleteBoard()};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        // Multipurpose function to close a popup window
        function closeWindow(){
            // Get channel window element and hide it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "none";
            // Reenable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "1";
            disable_content.style.pointerEvents = "auto";
        }

        // Multipurpose function to display an access denied message
        function accessDenied(){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Access Denied";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Only admins of the board can perform this action.";
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Hide the create button
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "none";
            // Change the close button to say "Close"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Close";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        // Multipurpose function to display an error message
        function error(errorHeader, errorString){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = errorHeader;
            // Display the error message
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = errorString;
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Hide the create button
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "none";
            // Change the close button to say "Close"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Close";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        //In the mobile version, click the hamburger menu to open the nav bar buttons
        function toggleHamburgerMenu(){
            var hamburger_menu = document.getElementById("hamburger-buttons");
            var navbar = document.getElementById("navbar");
            if (hamburger_menu.style.display != "inline-flex"){
                hamburger_menu.style.display = "inline-flex";
                navbar.style.height = "100px";
            }
            else{
                hamburger_menu.style.display = "none";
                navbar.style.height = "61px";
            }
        }   

        //For the mobile version, opening the sidebar by clicking on the arrow
        function openChannelsUsers(){
            var channels_users = document.getElementById("l-column");
            var arrow = document.getElementById("arrow")
            if (channels_users.style.transform == "translateX(0px)"){
                channels_users.style.transform = "translateX(-150%)";
                setTimeout(function() {
                    arrow.src = "./img/right_arrow.svg"
                }, 300);
            }
            else {
                channels_users.style.transform = "translateX(0px)";
                setTimeout(function() {
                    arrow.src = "./img/left_arrow.svg"
                }, 300);
            }
        }

        // Adding a new user to the board
        function newUser(){
            // Get the user name from the input box
            var userName = document.getElementById("name").value;
            if (userName != null && userName != "") {

                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                        //ticket not valid -> logout
                        if (this.responseText == "TICKET NOT VALID"){
                            window.location.href = './logout';
                        }

                        // If the user was added successfully, render the users column
                        if (this.responseText == "TRUE") {
                            renderUsers(userName);
                            closeWindow();
                        }
                        // If the user was not added successfully, display an error message
                        else if (this.responseText == "Access Denied"){
                            accessDenied();
                        }
                        else if (this.responseText == "Multiple Account with Email"){
                            error("Error adding user", "A user with this email already exists.");
                        }
                        else if (this.responseText == "Invalid Email"){
                            error("Error adding user", "A user with this email does not exist.");
                        }
                        else{
                            error("Error adding user", "Failed to add user. Please try again.");
                        }
                    }
                }
                xhr_fetch.open('POST', './add-member', false);
                xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr_fetch.send('board_id='+board_id+'&new_member_email='+userName);
            }
            //If the user name is invalid, display an error message
            else{
                error("Error adding user", "Invalid email.");
            }
        }

        // Deleting a user from the board
        function deleteUser(userName){

            var xhr_delete = new XMLHttpRequest();
            xhr_delete.onreadystatechange = function() {
                if(xhr_delete.readyState == 4 && xhr_delete.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    // If the user was deleted successfully, render the users column and close the window
                    if(this.responseText == "TRUE") {
                        renderUsers();
                        closeWindow();
                    }
                    // If the user was not deleted successfully, display an error message
                    else if(this.responseText == "Access Denied"){
                        accessDenied();
                    }
                    else if(this.responseText == "Admin cannot remove himself"){
                        error("Error removing user", "Admin cannot remove themself");
                    }
                    else{
                        console.log(this.responseText);
                        error("Error removing user", "Please Try Again");

                    }
                }
            }
            xhr_delete.open('POST', './remove-member', false);
            xhr_delete.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr_delete.send('board_id='+board_id+'&old_member_email='+userName);
        }

        // Rendering the users column
        function renderUsers(){

            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    var response = JSON.parse(xhr_fetch.responseText);
                    user_data = response.users;
                    var users = response.users;
                    var users_select = document.getElementById("users-select");
                    users_select.innerHTML = "";
                    for (var i = 0; i < users.length; i++) {
                        var newUser = document.createElement("div");
                        newUser.className = "user";
                        if (users[i] == my_username){
                            newUser.innerHTML = "<span>" + users[i] + "</span>";
                        }
                        else{
                            newUser.innerHTML = "<span>" + users[i] + "</span><img class=\"settings-icon\" src=\"./img/settings_icon.svg\" onclick=\"toggleDeleteUser(this)\">";
                        }
                        users_select.appendChild(newUser);
                    }

                }
            }
            xhr_fetch.open('POST', './fetch-board-users', true);  //asynchronous
            xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            var params = "boardId="+board_id;
            xhr_fetch.send(params);

        }


        // Choosing a channel
        function chooseChannel(channel){
            // Get the chosen channels name
            var channelName = channel.childNodes[0].innerHTML;
            // Set the active_channel variable to the chosen channel
            active_channel = channel_data.find(x => x.name === channelName).id;
            active_channel_name = channelName;
            // Reset the background colors of all channels
            var channels = document.getElementsByClassName("channel");
            for (var i = 0; i < channels.length; i++) {
                channels[i].style.backgroundColor = darkenColor(board_color, 40);
            }
            // Set the background color of the chosen channel
            channel.style.backgroundColor = darkenColor(board_color, 60);
            renderMessages();
            renderPinnedMessages();
        }

        // Creating a new channel
        function newChannel(channelName){
            // Check if the channel name is valid
            if (channelName != null && channelName != "" && isAlphaNumeric(channelName)) {

                var xhr_create = new XMLHttpRequest();
                xhr_create.onreadystatechange = function() {
                    if(xhr_create.readyState == 4 && xhr_create.status == 200) {

                        //ticket not valid -> logout
                        if (this.responseText == "TICKET NOT VALID"){
                            window.location.href = './logout';
                        }

                        // If the channel was created successfully, render the channels column, render messages, and close the window
                        if(this.responseText == "TRUE") {
                            renderChannels();  
                            renderMessages(); 
                            closeWindow();
                            chooseChannel(document.getElementsByClassName("channel")[channel_data.length-1]);
                        }
                        // If the channel was not created successfully, display an error message
                        else if (this.responseText == "Access Denied"){
                            accessDenied();
                        }
                        else{
                            error("Error creating channel", "Please Try Again");
                        }
                    }
                }
                xhr_create.open('POST', './create-channel', false);
                xhr_create.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_create.send('boardId='+board_id+'&name='+channelName);
            }
            else{
                error("Error creating channel", "Invalid channel name");
            }
        }

        // Deleting a channel
        function deleteChannel(channelName){

            var xhr_delete = new XMLHttpRequest();
            xhr_delete.onreadystatechange = function() {
                if(xhr_delete.readyState == 4 && xhr_delete.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    // If the channel was deleted successfully, render the channels column, render messages, and close the window
                    if(this.responseText == "TRUE") {
                        active_channel = channel_data[0].id;
                        renderChannels();  
                        renderMessages();    
                        closeWindow();
                    }
                    // If the channel was not deleted successfully, display an error message
                    else if(this.responseText == "Access Denied"){
                        accessDenied();
                    }
                    else{
                        error("Error deleting channel", "Please try again");
                    }
                }
            }
            xhr_delete.open('POST', './delete-channel', false);
            xhr_delete.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            channel_id = channel_data.find(x => x.name === channelName).id;
            xhr_delete.send('channel_id='+channel_id);
        }
                
        // Rendering the channels column
        function renderChannels(){

            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    // Parse the response data
                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    channel_data = parsed_data;
                    // If there is no active channel, set it to the first channel
                    if (active_channel == null){
                        // referencing the id produced an error even though the assignment worked as intended, this is why the try catch is used
                        try{
                            active_channel = channel_data[0].id;
                        }
                        catch(err){}
                    }
                    // Otherwise, set it to the last active channel, this occurs when a channel is deleted
                    else if (parsed_data.find(x => x.id === active_channel) == null){
                        active_channel = parsed_data[parsed_data.length-1].id;
                    }
                    // Get the channels column 
                    var channels = document.getElementById("channel-select");
                    // Clear the channels column
                    channels.innerHTML = "";
                    // Find the active channels name
                    try{
                        active_channel_name = parsed_data.find(x => x.id === active_channel).name;
                    }
                    catch(err){
                        active_channel_name = "General";
                    }
                    // Add each channel to the channels column
                    for (var i = 0; i < parsed_data.length; i++) {
                        var newChannel = document.createElement("div");
                        newChannel.className = "channel";
                        newChannel.addEventListener('mouseover', function() {
                            this.style.backgroundColor = darkenColor(board_color, 60);
                        });
                        newChannel.addEventListener('mouseout', function() {
                            if (this.childNodes[0].innerHTML != active_channel_name){
                                this.style.backgroundColor = darkenColor(board_color, 40);
                            }
                        });
                        newChannel.onclick = function() {chooseChannel(this)};
                        // If the channel is the general channel, do not add the settings icon, this channel cannot be deleted
                        if (parsed_data[i].name == "General"){
                            newChannel.innerHTML = "<span class=\"channel-name\">" + parsed_data[i].name + "</span>";
                        }
                        else {
                            newChannel.innerHTML = "<span class=\"channel-name\">" + parsed_data[i].name + "</span> <img class=\"settings-icon\" src=\"./img/settings_icon.svg\" onclick=\"toggleDeleteChannel(this)\">";
                        }
                        // If the channel is the active channel, set its background color to a darker gray
                        if (parsed_data[i].name == active_channel_name){
                            newChannel.style.backgroundColor = darkenColor(board_color, 60);
                        }
                        channels.appendChild(newChannel);
                    }
                    
                }
            }
            xhr_fetch.open('POST', './fetch-channels-list', false);
            xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr_fetch.send('boardId='+board_id);
        }
        
        // Sending a message
        function sendMessage() {
            var key = window.event.keyCode;
            // If the user presses enter and the message is not empty, send the message
            if (key === 13 && document.getElementsByClassName("text-box")[0].value != "") {

                // Getting the message content
                var message = document.getElementsByClassName("text-box")[0].value;
                var xhr_create = new XMLHttpRequest();
                xhr_create.onreadystatechange = function() {
                    if(xhr_create.readyState == 4 && xhr_create.status == 200) {

                        //ticket not valid -> logout
                        if (this.responseText == "TICKET NOT VALID"){
                            window.location.href = './logout';
                        }

                        // If the message was sent successfully, render the messages column
                        if(this.responseText == "TRUE") {
                            renderMessages();
                            //clearing the text box
                            document.getElementsByClassName("text-box")[0].value = "";
                            //scrolling to bottom of messages
                            messages.scrollTo(0, 1000);
                        }
                    }
                }
                xhr_create.open('POST', './create-message', false);
                xhr_create.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_create.send('channelId='+active_channel+'&message='+message);
            }
        }

        // Rendering the messages column
        function renderMessages(){

            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                // If the messages were fetched successfully, render the messages column
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    // Parse the response data
                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    message_data = JSON.parse(JSON.stringify(parsed_data));
                    function sortByDate(jsonArray) {
                        // Sort the array based on the "date" field
                        jsonArray.sort((a, b) => {
                            const dateA = new Date(a.date);
                            const dateB = new Date(b.date);

                            return dateA - dateB;
                        });

                        return jsonArray;
                    }
                    parsed_data = sortByDate(parsed_data);
                    // Get the messages column
                    var messages = document.getElementById("messages");
                    // Clear the messages column
                    messages.innerHTML = "";

                    // Get the pinned messages dropdown column
                    pinned_messages = document.getElementById("dropdown-menu");
                    // Clear the pinned messages dropdown column
                    pinned_messages.innerHTML = "";
                    for (var i = 0; i < parsed_data.length; i++) {
                        var newMessage = document.createElement("div");
                        newMessage.className = "message";
                        newMessage.id = parsed_data[i].id;
                        newMessage.is_pinned = parsed_data[i].is_pinned;

                        //creating the user html element
                        var user = document.createElement("div");
                        user.className = "username";
                        var split_username = parsed_data[i].username.split("@");
                        user.innerHTML = "<strong>" + split_username[0] + "</strong>";
                        //creating the datetime html element
                        var time = document.createElement("div");
                        time.className = "datetime";
                        time.innerHTML = parsed_data[i].date;
                        //creating the text html element
                        var text = document.createElement("div");
                        text.className = "text";
                        text.innerHTML = parsed_data[i].message;
                        //create the pin message icon
                        var pin = document.createElement("img");
                        pin.className = "pin-icon pin";
                        pin.src = "./img/pin_icon.svg";
                        pin.onclick = function() {pinMessage(this)};
                        //create the pinned message mark
                        var pinned_mark = document.createElement("div");
                        pinned_mark.id = "pinned-mark";
                        pinned_mark.innerHTML = "Pinned";
                        //adding user and text as children of newMessage
                        newMessage.appendChild(user);
                        newMessage.appendChild(time);
                        newMessage.appendChild(pin);
                        newMessage.appendChild(pinned_mark);
                        if (newMessage.is_pinned == 0){
                            newMessage.childNodes[3].style.display = "none";
                        }
                        else{
                            newMessage.childNodes[3].style.display = "inline";
                        }
                        newMessage.appendChild(text);
                        //adding newMessage to messages
                        messages.appendChild(newMessage);
                    }
                }
            }
            xhr_fetch.open('POST', './fetch-messages-list', false);
            xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr_fetch.send('channelId='+active_channel);
        }

        //leave a board if you're not the admin
        function leaveBoard(){

            var xhr_delete = new XMLHttpRequest();
            xhr_delete.onreadystatechange = function() {
                if(xhr_delete.readyState == 4 && xhr_delete.status == 200) {
                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    // If the message was sent successfully, redirect to the select discussion page
                    if(this.responseText == "TRUE") {
                        window.location.href = './select-discussion';
                    }
                }
            }
            xhr_delete.open('POST', './leave-board', false);
            xhr_delete.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr_delete.send("board_id="+board_id);
        }

        //delete a board if you're the admin
        function deleteBoard(){

            var xhr_delete = new XMLHttpRequest();
            xhr_delete.onreadystatechange = function() {
                if(xhr_delete.readyState == 4 && xhr_delete.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    // If the message was sent successfully, redirect to the select discussion page
                    if(this.responseText == "TRUE") {
                        window.location.href = './select-discussion';
                    }
                }
            }
            xhr_delete.open('POST', './delete-board', false);
            xhr_delete.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr_delete.send("board_id="+board_id);
        } 

        //Check if the user is an admin and set the global variable
        function is_admin(){

            var xhr_check = new XMLHttpRequest();
            xhr_check.onreadystatechange = function() {
                if(xhr_check.readyState == 4 && xhr_check.status == 200) {

                    //ticket not valid -> logout
                    if (this.responseText == "TICKET NOT VALID"){
                        window.location.href = './logout';
                    }

                    if(this.responseText == "TRUE") {
                        cur_is_admin = true;
                    } else {
                        cur_is_admin = false;
                    }
                }
            }
            xhr_check.open('POST', './is-admin', false);
            xhr_check.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr_check.send("board_id="+board_id);
        }

    </script>
</body>