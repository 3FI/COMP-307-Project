<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="discussion.css">
    <title>Discussion Page</title>
    <link rel="icon" type="image/x-icon" href="/img/logo.ico">
</head>

<body onload="renderContent()">
<!-- <body> -->
    <nav class="navbar navbar-expand-lg" id="navbar">
        <div class="container-fluid">
            <img src="/img/logo.png" alt="logo" class="d-inline-block align-top" style="width:30px;height:30px;margin-right:10px;">
            <span class="navbar-brand" id="board-name" href="#" style="color: white;"></span>
            <div class="navbar-modified" id="navbarText">
                <ul class="navbar-nav me-auto mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="select-discussion.html" style="color: white;">Home</a>
                    </li>
                </ul>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" id="dropdown-button" type="button" onclick="togglePinnedMessages()" data-bs-toggle="dropdown" aria-expanded="false">
                      <img src="./img/pin_icon.svg" style="padding-right: 6px; padding-bottom: 4px;">
                        Pinned
                    </button>
                    <div id="close-menu-overlay" onclick="togglePinnedMessages()"></div>
                    <div class="dropdown-menu" id="dropdown-menu">
                      
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="leaveBoard()" style="margin-right: 6px;">Leave board</button>
                <form action="/logout" method="post">
                    <button type="logout" class="btn logout logout-btn">Logout</button>
                </form>
            </div>
        </div>
    </nav>
    <div id="create-new-window">
        <div class="header" id="create-new-header"></div>
        <div id="enter-below"></div>
        <input type="text" id="name" placeholder="">
        <small id="valid-input"></small>
        <div class="buttons">
            <button type="button" class="btn btn-secondary cancel-btn" id="close-btn" onclick="closeWindow()">Cancel</button>
            <button type="button" class="btn btn-primary" id="create-btn"></button>
        </div>
    </div>
    <div class="container-fluid" id="disable">
        <div class="row">
            <div class="channels-users col-lg-2 col-md-3 col-sm-4 col-4">
                <div class="header channels">
                    <span class="navbar-brand">Channels</span>
                    <span class="new-channel-btn navbar-brand" onclick="toggleNewChannel()">+</span>
                </div>
                <div id="channel-select">
                    <div class="channel" onclick="chooseChannel(this)">
                    </div>
                </div>
                <div class="header users">
                    <span class="navbar-brand">Users</span>
                    <span class="new-channel-btn navbar-brand" onclick="toggleNewUser()">+</span>
                </div>
                <div id="users-select">
                </div>
            </div>
            <div class="discussion col-lg-10 col-md-9 col-sm-8 col-8">
                <input class="text-box" type="text" onkeypress="sendMessage();" placeholder="Type your message here...">
                <div class="text-box-background"></div>
                <div id="messages">
                    <div class="message">
                        <!-- <div class="username"><strong>User 1</strong></div>
                        <div class="datetime">2023/8/2</div>
                        <img src="./img/pin_icon.svg" alt="" class="pin-icon" onclick="pinMessage(this)">
                        <div id="pinned-mark">Pinned</div>
                        <div class="text">Test message</div> -->
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <script>
        var channel_data = {}; 
        var user_data = {};
        var message_data = {};
        var active_channel = null;
        var board_id = '';
        var board_color = '';
        //TODO: change to actual username
        var my_username = 'matan@atlas.com';
        const queryParams = new URLSearchParams(window.location.search);
        var board_name = queryParams.get('boardname');
        document.getElementById("board-name").innerHTML = board_name;
        getBoardId(board_name);

        // Set interval to execute the function every second (1000 milliseconds)
        setInterval(checkForUpdates, 1000);

        function checkForUpdates(){

            function checkForChannelsUpdates(){
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                        var response = JSON.parse(xhr_fetch.responseText);
                        if (!areJSONObjectsEqual(response, channel_data)){
                            renderChannels();
                        }
                    }
                }
                xhr_fetch.open('POST', '/fetch-channels-list', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_fetch.send('boardId='+board_id);
            }
            function checkForUsersUpdates() {
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                        var response = JSON.parse(xhr_fetch.responseText);
                        if (!areJSONObjectsEqual(response, user_data)){
                            renderUsers();
                        }
                    }
                }
                xhr_fetch.open('POST', '/fetch-board-users', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                var params = "boardId="+board_id;
                xhr_fetch.send(params);
            }
            function checkForMessagesUpdates(){
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                        var response = JSON.parse(xhr_fetch.responseText);
                        response.forEach(elm=> delete elm['is_pinned']);
                        var msg_data_without_pinned = message_data;
                        msg_data_without_pinned.forEach(elm=> delete elm['is_pinned']);
                        if (!areJSONObjectsEqual(response, msg_data_without_pinned)){
                            renderMessages();
                            //scrolling to bottom of messages
                            messages.scrollTo(0, 1000);
                        }
                    }
                }
                xhr_fetch.open('POST', '/fetch-messages-list', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_fetch.send('channelId='+active_channel);
            }
            function checkForPinnedMessagesUpdates(){
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                        var response = JSON.parse(xhr_fetch.responseText);
                        if (!areJSONObjectsEqual(response, message_data)){
                            renderPinnedMessages();
                        }
                    }
                }
                xhr_fetch.open('POST', '/fetch-messages-list', true);  //asynchronous
                xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_fetch.send('channelId='+active_channel);
            }
            function areJSONObjectsEqual(obj1, obj2) {
                const jsonString1 = JSON.stringify(obj1);
                const jsonString2 = JSON.stringify(obj2);

                return jsonString1 === jsonString2;
            }

            checkForChannelsUpdates();
            checkForUsersUpdates();
            checkForMessagesUpdates();
            checkForPinnedMessagesUpdates();
        }


        //getMyUsername();
        
        // function getMyUsername(){
        //     var xhr_fetch = new XMLHttpRequest();
        //     xhr_fetch.onreadystatechange = function() {
        //         if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
        //             console.log(this.responseText);
        //         }
        //     }
        //     xhr_fetch.open('GET', '/fetch-username', false); 
        //     xhr_fetch.send();
        // }
        
        function scrollToElm(container, elm_id, duration){
            var elm = document.getElementById(elm_id);
            var pos = getRelativePos(elm);
            scrollTo( container, pos.top , duration);  // duration in seconds
            }

            function getRelativePos(elm){
            var pPos = elm.parentNode.getBoundingClientRect(), // parent pos
                cPos = elm.getBoundingClientRect(), // target pos
                pos = {};

            pos.top    = cPos.top    - pPos.top + elm.parentNode.scrollTop,
            pos.right  = cPos.right  - pPos.right,
            pos.bottom = cPos.bottom - pPos.bottom,
            pos.left   = cPos.left   - pPos.left;

            return pos;
        }
                
        function scrollTo(element, to, duration, onDone) {
            var start = element.scrollTop,
                change = to - start,
                startTime = performance.now(),
                val, now, elapsed, t;

            function animateScroll(){
                now = performance.now();
                elapsed = (now - startTime)/1000;
                t = (elapsed/duration);

                element.scrollTop = start + change * easeInOutQuad(t);

                if( t < 1 )
                    window.requestAnimationFrame(animateScroll);
                else
                    onDone && onDone();
            };

            animateScroll();
        };

        function easeInOutQuad(t){ return t<.5 ? 2*t*t : -1+(4-2*t)*t };

        function getBoardId(board_name){
            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                    // Parse the response data
                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    for (var i = 0; i < parsed_data.length; i++) {
                        if (parsed_data[i].name == board_name){
                            board_id = parsed_data[i].id;
                            board_color = parsed_data[i].color;
                        }
                    }
                }
            }
            xhr_fetch.open('GET', '/fetch-board-list', false);  // Set the third parameter to false for a synchronous request
            xhr_fetch.send();
        }
        
        function renderContent(){
            renderChannels();
            if (channel_data.length == 0){
                newChannel("General");
            }
            active_channel = channel_data[0].id;
            channels = document.getElementsByClassName("channel");
            channels[0].style.backgroundColor = "#777575";
            renderMessages();   
            renderPinnedMessages();  
            renderUsers();
            var navbar = document.getElementById("navbar");
            navbar.style.backgroundColor = board_color;

        }

        function isAlphaNumeric(str) {
            var code, i, len;
            let empty = true;
            for (i = 0, len = str.length; i < len; i++) {
                code = str.charCodeAt(i);
                if (code != 32) {
                    empty = false;
                }
                if (!(code > 47 && code < 58) && // numeric (0-9)
                    !(code > 64 && code < 91) && // upper alpha (A-Z)
                    !(code > 96 && code < 123) && // lower alpha (a-z)
                    !(code == 32)) { // space
                        return false;
                }
            }
            return !(empty);
        };

        function togglePinnedMessages(){
            var dropdown = document.getElementById("dropdown-menu");
            var overlay = document.getElementById("close-menu-overlay");
            if (dropdown.style.display != "block"){
                dropdown.style.display = "block";
                overlay.style.display = "block";
            }
            else{
                dropdown.style.display = "none";
                overlay.style.display = "none";
            }
        }

        //Call the server to update the message as pinned
        function pinMessage(pinButton){
            
            message = pinButton.parentNode;
            
            message_id = message.id;
            
            is_pinned = message.is_pinned;

            var xhr_update = new XMLHttpRequest();
            xhr_update.onreadystatechange = function() {
                if(xhr_update.readyState == 4 && xhr_update.status == 200) {

                    var response = JSON.parse(xhr_update.responseText);
                    if (message.is_pinned == 1){
                        message.is_pinned = 0;
                        message.childNodes[3].style.display = "none";
                    }
                    else{
                        message.is_pinned = 1;
                        message.childNodes[3].style.display = "inline";
                    }
                    renderPinnedMessages();
                }
            }

            xhr_update.open('POST', '/update-pinned-message', true);  //asynchronous
            xhr_update.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            var params = "message_id="+message_id+"&pinned_status="+is_pinned;
            xhr_update.send(params);
        }

        function renderPinnedMessages(){
            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                // If the messages were fetched successfully, render the messages column
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                    // Parse the response data
                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    // Get the pinned messages dropdown column
                    pinned_messages = document.getElementById("dropdown-menu");
                    // Clear the pinned messages dropdown column
                    pinned_messages.innerHTML = "";
                    num_pinned = 0;
                    for (var i = 0; i < parsed_data.length; i++) {
                        if (parsed_data[i].is_pinned == 1){
                            num_pinned++;
                            //create the pinned message element
                            var pinned_message = document.createElement("div");
                            //set class name
                            pinned_message.className = "message mx-1";
                            pinned_message.onclick = function() {scrollToPinnedMessage(this.childNodes[4].innerHTML)};

                            //creating the user html element
                            var user = document.createElement("div");
                            user.className = "username";
                            var split_username = parsed_data[i].username.split("@");
                            user.innerHTML = "<strong>" + split_username[0] + "</strong>";
                            //creating the datetime html element
                            var time = document.createElement("div");
                            time.className = "datetime";
                            time.innerHTML = parsed_data[i].date;
                            //creating the text html element
                            var text = document.createElement("div");
                            text.className = "text";
                            text.innerHTML = parsed_data[i].message;
                            var pinned_id = document.createElement("p");
                            pinned_id.setAttribute("hidden", true);
                            pinned_id.innerHTML = parsed_data[i].id;
                            //create the pin message icon
                            var pin = document.createElement("img");
                            pin.className = "pin-icon";
                            pin.src = "./img/pin_icon.svg";
                            pin.onclick = function() {
                                this.parentNode.onclick = null;
                                var pinned_message = document.getElementById(pinned_id.innerHTML);
                                pinMessage(pinned_message.childNodes[2]);
                                this.parentNode.onclick = function() {scrollToPinnedMessage(this.parentNode.childNodes[4].innerHTML)};
                            };

                            // pinned_message.innerHTML = "<div class=\"pinned-user\"><strong>" + parsed_data[i].username + "</strong></div><div class=\"text pinned-text\">" + parsed_data[i].message + "</div>";
                            pinned_message.appendChild(user);
                            pinned_message.appendChild(time);
                            pinned_message.appendChild(pin);
                            pinned_message.appendChild(text);
                            pinned_message.appendChild(pinned_id);
                            pinned_messages.appendChild(pinned_message);
                        }
                    }
                    if (num_pinned == 0){
                        var pinned_message = document.createElement("div");
                        pinned_message.className = "mx-1";
                        pinned_message.innerHTML = "<div class=\"text pinned-text\">No pinned messages</div>";
                        pinned_messages.appendChild(pinned_message);
                    }
                }
            }
            xhr_fetch.open('POST', '/fetch-messages-list', false);
            xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr_fetch.send('channelId='+active_channel);
        }

        function scrollToPinnedMessage(pinned_id){
            var pinned_message = document.getElementById(pinned_id);
            var pinned_messages = document.getElementById("messages");
            scrollToElm(pinned_messages, pinned_id, 0.5);
        }

        //Open a window allowing to create a new channel
        function toggleNewChannel(){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Create New Channel";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Enter the name of the new channel below:";
            // Clear the input box and set its placeholder
            var name = document.getElementById("name");
            name.style.display = "inline-block";
            name.value = "";
            name.placeholder = "Channel Name";
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            name.onchange = function() {
                if (channelNameExists(name.value)){
                    valid.innerHTML = "Channel name already exists";
                    document.getElementById("create-btn").disabled = true;
                }
                else{
                    valid.innerHTML = "";
                    document.getElementById("create-btn").disabled = false;
                }
            };
            // Change the create button to say "Create Channel" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Create Channel";
            create_btn.onclick = function() {newChannel(name.value)};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function channelNameExists(channelName){
            for (var i = 0; i < channel_data.length; i++) {
                if (channel_data[i].name == channelName){
                    return true;
                }
            }
            return false;
        }

        //Open a window allowing to delete a channel
        function toggleDeleteChannel(button){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Delete Channel";
            // Get the channel name from the button and display confirmation message
            var enter_below = document.getElementById("enter-below");
            channelName = button.parentNode.childNodes[0].innerHTML;
            enter_below.innerHTML = "Are you sure you want to delete the channel " + channelName + "?";
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Clear the message for duplicate additions
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            // Change the create button to say "Delete Channel" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Delete Channel";
            create_btn.onclick = function() {deleteChannel(channelName)};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        //Open a window allowing to add a new user
        function toggleNewUser(){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Add New User";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Enter the email of the new user below:";
            // Clear the input box and set its placeholder
            var name = document.getElementById("name");
            name.style.display = "inline-block";
            name.value = "";
            name.placeholder = "email";
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            name.onchange = function() {
                if (userExists(name.value)){
                    valid.innerHTML = "User already exists";
                    document.getElementById("create-btn").disabled = true;
                }
                else{
                    valid.innerHTML = "";
                    document.getElementById("create-btn").disabled = false;
                }
            };
            // Change the create button to say "Add User" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Add User";
            create_btn.onclick = function() {newUser()};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function userExists(userName){
            for (var i = 0; i < user_data.length; i++) {
                if (user_data[i] == userName){
                    return true;
                }
            }
            return false;
        }

        //Open a window allowing to delete a user
        function toggleDeleteUser(button){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Remove User From Board";
            // Get the user name from the button and display confirmation message
            var enter_below = document.getElementById("enter-below");
            userName = button.parentNode.childNodes[0].innerHTML;
            enter_below.innerHTML = "Are you sure you want to remove the user " + userName + "?";
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Clear the message for duplicate additions
            valid = document.getElementById("valid-input")
            valid.innerHTML = "";
            // Change the create button to say "Remove User" and set its onclick function
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "inline-block";
            create_btn.innerHTML = "Remove User";
            create_btn.onclick = function() {deleteUser(userName)};
            // Change the close button to say "Cancel"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Cancel";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        // Multipurpose function to close a popup window
        function closeWindow(){
            // Get channel window element and hide it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "none";
            // Reenable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "1";
            disable_content.style.pointerEvents = "auto";
        }

        // Multipurpose function to display an access denied message
        function accessDenied(){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Access Denied";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Only admins of the board can perform this action.";
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Hide the create button
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "none";
            // Change the close button to say "Close"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Close";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        // Multipurpose function to display an error message
        function errorAddingUser(errorString){
            // Get channel window element and display it
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            // Get channel window elements and change their content
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Error Adding User";
            // Display the error message
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = errorString;
            // Hide the input box
            var name = document.getElementById("name");
            name.style.display = "none";
            // Hide the create button
            var create_btn = document.getElementById("create-btn");
            create_btn.style.display = "none";
            // Change the close button to say "Close"
            var close_btn = document.getElementById("close-btn");
            close_btn.innerHTML = "Close";
            // Disable the rest of the page
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        // Adding a new user to the board
        function newUser(){
            // Get the user name from the input box
            var userName = document.getElementById("name").value;
            if (userName != null && userName != "") {
                var xhr_fetch = new XMLHttpRequest();
                xhr_fetch.onreadystatechange = function() {
                    if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                        // If the user was added successfully, render the users column
                        if (this.responseText == "TRUE") {
                            renderUsers(userName);
                        }
                        // If the user was not added successfully, display an error message
                        else if (this.responseText == "Access Denied"){
                            accessDenied();
                        }
                        else if (this.responseText == "Multiple Account with Email"){
                            errorAddingUser("A user with this email already exists.");
                        }
                        else if (this.responseText == "Invalid Email"){
                            errorAddingUser("Invalid email.");
                        }
                        else{
                            console.log(this.responseText);
                        }
                    }
                }
                xhr_fetch.open('POST', '/add-member', false);
                xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr_fetch.send('board_id='+board_id+'&new_member_email='+userName);
            }
            //If the user name is invalid, display an error message, change from alert
            else{
                errorAddingUser("Invalid email.");
            }
        }

        // Deleting a user from the board
        function deleteUser(userName){
            var xhr_delete = new XMLHttpRequest();
            xhr_delete.onreadystatechange = function() {
                if(xhr_delete.readyState == 4 && xhr_delete.status == 200) {
                    // If the user was deleted successfully, render the users column and close the window
                    if(this.responseText == "TRUE") {
                        renderUsers();
                        closeWindow();
                    }
                    // If the user was not deleted successfully, display an error message
                    else if(this.responseText == "Access Denied"){
                        accessDenied();
                    }
                    else{
                        // alert("Error deleting user");
                        console.log(this.responseText);
                    }
                }
            }
            xhr_delete.open('POST', '/remove-member', false);
            xhr_delete.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr_delete.send('board_id='+board_id+'&old_member_email='+userName);
        }

        // Rendering the users column
        function renderUsers(){
            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                    var response = JSON.parse(xhr_fetch.responseText);
                    user_data = response.users;
                    var users = response.users;
                    var users_select = document.getElementById("users-select");
                    users_select.innerHTML = "";
                    for (var i = 0; i < users.length; i++) {
                        var newUser = document.createElement("div");
                        newUser.className = "user";
                        if (users[i] == my_username){
                            newUser.innerHTML = "<span>" + users[i] + "</span>";
                        }
                        else{
                            newUser.innerHTML = "<span>" + users[i] + "</span><img class=\"settings-icon\" src=\"./img/settings_icon.svg\" onclick=\"toggleDeleteUser(this)\">";
                        }
                        users_select.appendChild(newUser);
                    }

                }
            }
            xhr_fetch.open('POST', '/fetch-board-users', true);  //asynchronous
            xhr_fetch.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            var params = "boardId="+board_id;
            xhr_fetch.send(params);

        }


        // Choosing a channel
        function chooseChannel(channel){
            // Get the chosen channels name
            var channelName = channel.childNodes[0].innerHTML;
            // Set the active_channel variable to the chosen channel
            active_channel = channel_data.find(x => x.name === channelName).id;
            // Reset the background colors of all channels
            var channels = document.getElementsByClassName("channel");
            for (var i = 0; i < channels.length; i++) {
                channels[i].style.backgroundColor = "darkgray";
            }
            // Set the background color of the chosen channel
            channel.style.backgroundColor = "#777575";
            renderMessages();
            renderPinnedMessages();
        }

        // Creating a new channel
        function newChannel(channelName){
            // Check if the channel name is valid
            if (channelName != null && channelName != "" && isAlphaNumeric(channelName)) {
                var xhr_create = new XMLHttpRequest();
                xhr_create.onreadystatechange = function() {
                    if(xhr_create.readyState == 4 && xhr_create.status == 200) {
                        // If the channel was created successfully, render the channels column, render messages, and close the window
                        if(this.responseText == "TRUE") {
                            renderChannels();  
                            renderMessages(); 
                            closeWindow();
                        }
                        // If the channel was not created successfully, display an error message
                        else if (this.responseText == "Access Denied"){
                            accessDenied();
                        }
                        else{
                            alert("Error creating channel");
                        }
                    }
                }
                xhr_create.open('POST', '/create-channel', false);
                xhr_create.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_create.send('boardId='+board_id+'&name='+channelName);
            }
            // TODO: Change from alert
            else{
                alert("Invalid channel name");
            }
        }

        // Deleting a channel
        function deleteChannel(channelName){
            var xhr_delete = new XMLHttpRequest();
            xhr_delete.onreadystatechange = function() {
                if(xhr_delete.readyState == 4 && xhr_delete.status == 200) {
                    // If the channel was deleted successfully, render the channels column, render messages, and close the window
                    if(this.responseText == "TRUE") {
                        active_channel = channel_data[0].id;
                        renderChannels();  
                        renderMessages();    
                        closeWindow();
                    }
                    // If the channel was not deleted successfully, display an error message
                    else if(this.responseText == "Access Denied"){
                        accessDenied();
                    }
                    else{
                        alert("Error deleting channel");
                    }
                }
            }
            xhr_delete.open('POST', '/delete-channel', false);
            xhr_delete.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            channel_id = channel_data.find(x => x.name === channelName).id;
            xhr_delete.send('channel_id='+channel_id);
        }
                
        // Rendering the channels column
        function renderChannels(){
            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                    // Parse the response data
                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    channel_data = parsed_data;
                    // If there is no active channel, set it to the first channel
                    if (active_channel == null){
                        active_channel = channel_data[0].id;
                    }
                    // Otherwise, set it to the last active channel, this occurs when a channel is deleted
                    else if (parsed_data.find(x => x.id === active_channel) == null){
                        active_channel = parsed_data[parsed_data.length-1].id;
                    }
                    // Get the channels column 
                    var channels = document.getElementById("channel-select");
                    // Clear the channels column
                    channels.innerHTML = "";
                    // Find the active channels name
                    active_channel_name = parsed_data.find(x => x.id === active_channel).name;
                    // Add each channel to the channels column
                    for (var i = 0; i < parsed_data.length; i++) {
                        var newChannel = document.createElement("div");
                        newChannel.className = "channel";
                        newChannel.onclick = function() {chooseChannel(this)};
                        // If the channel is the general channel, do not add the settings icon, this channel cannot be deleted
                        if (parsed_data[i].name == "General"){
                            newChannel.innerHTML = "<span class=\"channel-name\">" + parsed_data[i].name + "</span>";
                        }
                        else {
                            newChannel.innerHTML = "<span class=\"channel-name\">" + parsed_data[i].name + "</span> <img class=\"settings-icon\" src=\"./img/settings_icon.svg\" onclick=\"toggleDeleteChannel(this)\">";
                        }
                        // If the channel is the active channel, set its background color to a darker gray
                        if (parsed_data[i].name == active_channel_name){
                            newChannel.style.backgroundColor = "#777575";
                        }
                        channels.appendChild(newChannel);
                    }
                    
                }
            }
            xhr_fetch.open('POST', '/fetch-channels-list', false);
            xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr_fetch.send('boardId='+board_id);
        }
        
        // Sending a message
        function sendMessage() {
            var key = window.event.keyCode;
            // If the user presses enter and the message is not empty, send the message
            if (key === 13 && document.getElementsByClassName("text-box")[0].value != "") {
                // Getting the message content
                var message = document.getElementsByClassName("text-box")[0].value;
                var xhr_create = new XMLHttpRequest();
                xhr_create.onreadystatechange = function() {
                    if(xhr_create.readyState == 4 && xhr_create.status == 200) {
                        // If the message was sent successfully, render the messages column
                        if(this.responseText == "TRUE") {
                            renderMessages();
                            //clearing the text box
                            document.getElementsByClassName("text-box")[0].value = "";
                            //scrolling to bottom of messages
                            messages.scrollTo(0, 1000);
                        }
                    }
                }
                xhr_create.open('POST', '/create-message', false);
                xhr_create.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                xhr_create.send('channelId='+active_channel+'&message='+message);
            }
        }

        // Rendering the messages column
        function renderMessages(){
            var xhr_fetch = new XMLHttpRequest();
            xhr_fetch.onreadystatechange = function() {
                // If the messages were fetched successfully, render the messages column
                if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                    // Parse the response data
                    data = this.responseText;
                    parsed_data = JSON.parse(data);
                    message_data = parsed_data;
                    // Get the messages column
                    var messages = document.getElementById("messages");
                    // Clear the messages column
                    messages.innerHTML = "";

                    // Get the pinned messages dropdown column
                    pinned_messages = document.getElementById("dropdown-menu");
                    // Clear the pinned messages dropdown column
                    pinned_messages.innerHTML = "";
                    for (var i = 0; i < parsed_data.length; i++) {
                        var newMessage = document.createElement("div");
                        newMessage.className = "message";
                        newMessage.id = parsed_data[i].id;
                        newMessage.is_pinned = parsed_data[i].is_pinned;

                        //creating the user html element
                        var user = document.createElement("div");
                        user.className = "username";
                        var split_username = parsed_data[i].username.split("@");
                        user.innerHTML = "<strong>" + split_username[0] + "</strong>";
                        //creating the datetime html element
                        var time = document.createElement("div");
                        time.className = "datetime";
                        time.innerHTML = parsed_data[i].date;
                        //creating the text html element
                        var text = document.createElement("div");
                        text.className = "text";
                        text.innerHTML = parsed_data[i].message;
                        //create the pin message icon
                        var pin = document.createElement("img");
                        pin.className = "pin-icon";
                        pin.src = "./img/pin_icon.svg";
                        pin.onclick = function() {pinMessage(this)};
                        //create the pinned message mark
                        var pinned_mark = document.createElement("div");
                        pinned_mark.id = "pinned-mark";
                        pinned_mark.innerHTML = "Pinned";
                        //adding user and text as children of newMessage
                        newMessage.appendChild(user);
                        newMessage.appendChild(time);
                        newMessage.appendChild(pin);
                        newMessage.appendChild(pinned_mark);
                        if (newMessage.is_pinned == 0){
                            newMessage.childNodes[3].style.display = "none";
                        }
                        else{
                            newMessage.childNodes[3].style.display = "inline";
                        }
                        newMessage.appendChild(text);
                        //adding newMessage to messages
                        messages.appendChild(newMessage);
                    }
                }
            }
            xhr_fetch.open('POST', '/fetch-messages-list', false);
            xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr_fetch.send('channelId='+active_channel);
        }

        function leaveBoard(){

            if (confirm("Do you really want to leave the discussion board ?") == true) {
                var xhr_delete = new XMLHttpRequest();
                xhr_delete.onreadystatechange = function() {
                    if(xhr_delete.readyState == 4 && xhr_delete.status == 200) {
                        console.log(this.responseText);
                        // If the message was sent successfully, render the messages column
                        if(this.responseText == "TRUE") {
                            window.location.href = '/select-discussion';
                        }
                    }
                }
            xhr_delete.open('POST', '/leave-board', false);
            xhr_delete.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr_delete.send("board_id="+board_id);
            } 

        }

    </script>
</body>