<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="discussion.css">
    <title>Discussion Page</title>
</head>

<body onload="getChannels()">
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand" href="#">Current Discussion Name</span>
            <div class="navbar-modified" id="navbarText">
                <ul class="navbar-nav me-auto mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="select-discussion.html">Home</a>
                    </li>
                </ul>
                <form action="/logout">
                    <button type="logout" class="btn btn-secondary">Logout</button>
                </form>
            </div>
        </div>
    </nav>
    <div id="create-new-window">
        <div class="header" id="create-new-header"></div>
        <div id="enter-below"></div>
        <input type="text" id="name" placeholder="">
        <div class="buttons">
            <button type="button" class="btn btn-secondary" onclick="closeWindow()">Cancel</button>
            <button type="button" class="btn btn-primary" id="create-btn"></button>
        </div>
    </div>
    <div class="container-fluid" id="disable">
        <div class="row">
            <div class="channels-users col-lg-2 col-md-3 col-sm-4 col-4">
                <div class="header channels">
                    <span class="navbar-brand">Channels</span>
                    <span class="new-channel-btn navbar-brand" onclick="toggleNewChannel()">+</span>
                </div>
                <div id="channel-select">
                    <div class="channel">
                        <span class="channel-name">Channel 1</span>
                    </div>
                    <div class="channel">
                        <span class="channel-name">Channel 2</span>
                    </div>
                </div>
                <div class="header users">
                    <span class="navbar-brand">Users</span>
                    <span class="new-channel-btn navbar-brand" onclick="toggleNewUser()">+</span>
                </div>
                <div id="users-select">
                    <div class="user">
                        <span class="user-name">User 1</span>
                    </div>
                    <div class="user">
                        <span class="user-name">User 2</span>
                    </div>
                </div>
            </div>
            <div class="discussion col-lg-10 col-md-9 col-sm-8 col-8">
                <input class="text-box" type="text" onkeypress="sendMessage();" placeholder="Type your message here...">
                <div class="text-box-background"></div>
                <div id="messages">
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Quia eligendi autem maxime. Maxime nisi ea accusantium quaerat iure exercitationem non aliquid, optio tempora mollitia neque, unde sed vitae magni sequi.
                   sicing elit. Quia eligendi autem maxime. Maxime nisi ea accusantium quaerat iure exercitationem non aliquid, optio tempora mollitia neque, unde sed vitae magni sequi.
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Quia eligendi autem maxime. Maxime nisi ea accusantium quaerat iure exercitationem non aliquid, optio tempora mollitia neque, unde sed vitae magni sequi.
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Quia eligendi autem maxime. Maxime nisi ea accusantium quaerat iure exercitationem non aliquid, optio tempora mollitia neque, unde sed vitae magni sequi.
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Quia eligendi autem maxime. Maxime nisi ea accusantium quaerat iure exercitationem non aliquid, optio tempora mollitia neque, unde sed vitae magni sequi.
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Quia eligendi autem maxime. Maxime nisi ea accusantium quaerat iure exercitationem non aliquid, optio tempora mollitia neque, unde sed vitae magni sequi.
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Quia eligendi autem maxime. Maxime nisi ea accusantium quaerat iure exercitationem non aliquid, optio tempora mollitia neque, unde sed vitae magni sequi.
                    aowidjawiodj
                </div>

            </div>
        </div>
    </div>
    
    <script>
        // test function to add messages to the discussion
        function sendMessage() {
            var key = window.event.keyCode;
            if (key === 13 && document.getElementsByClassName("text-box")[0].value != "") {
                // Getting required elements
                var message = document.getElementsByClassName("text-box")[0].value;
                var messages = document.getElementById("messages");
                //creating new message html element
                var newMessage = document.createElement("div");
                newMessage.className = "message";
                //creating the user html element
                var user = document.createElement("div");
                user.className = "username";
                user.innerHTML = "<strong>User 1</strong>";
                //creating the datetime html element
                var time = document.createElement("div");
                time.className = "datetime";
                const date = new Date();
                time.innerHTML = date.getMonth() + "/" + date.getDate() + "/" + date.getFullYear()  + " "  + date.getHours() + ":" + date.getMinutes();
                console.log(time.innerHTML);
                //creating the text html element
                var text = document.createElement("div");
                text.className = "text";
                text.innerHTML = message;
                //adding user and text as children of newMessage
                newMessage.appendChild(user);
                newMessage.appendChild(time);
                newMessage.appendChild(text);
                //adding newMessage to messages
                messages.appendChild(newMessage);
                //clearing the text box
                document.getElementsByClassName("text-box")[0].value = "";
                //scrolling to bottom of messages
                messages.scrollTo(0, 1000);
            }
        }

        function isAlphaNumeric(str) {
            var code, i, len;
            let empty = true;
            for (i = 0, len = str.length; i < len; i++) {
                code = str.charCodeAt(i);
                if (code != 32) {
                    empty = false;
                }
                if (!(code > 47 && code < 58) && // numeric (0-9)
                    !(code > 64 && code < 91) && // upper alpha (A-Z)
                    !(code > 96 && code < 123) && // lower alpha (a-z)
                    !(code == 32)) { // space
                        return false;
                }
            }
            return !(empty);
        };

        function toggleNewChannel(){
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            new_channel_window.style.display = "flex";
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Create New Channel";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Enter the name of the new channel below:";
            var name = document.getElementById("name");
            name.value = "";
            name.placeholder = "Channel Name";
            var create_btn = document.getElementById("create-btn");
            create_btn.innerHTML = "Create Channel";
            create_btn.onclick = function() {newChannel()};
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function newChannel(){
            var channelName = document.getElementById("name").value;
            if (channelName != null && channelName != "" && isAlphaNumeric(channelName)) {
                // Check if channel name already exists

                // If channel name does not exist, create channel
                var channels = document.getElementById("channel-select");
                var newChannel = document.createElement("div");
                newChannel.className = "channel";
                newChannel.innerHTML = "<span class=\"channel-name\">" + channelName + "</span>";
                channels.appendChild(newChannel);
                closeWindow();
            }
            else{
                alert("Invalid channel name");
            }
        }

        function toggleNewUser(){
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "flex";
            var new_channel_header = document.getElementById("create-new-header");
            new_channel_header.innerHTML = "Add New User";
            var enter_below = document.getElementById("enter-below");
            enter_below.innerHTML = "Enter the username of the new user below:";
            var name = document.getElementById("name");
            name.value = "";
            name.placeholder = "username";
            var create_btn = document.getElementById("create-btn");
            create_btn.innerHTML = "Add User";
            create_btn.onclick = function() {newUser()};
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "0.5";
            disable_content.style.pointerEvents = "none";
        }

        function newUser(){
            var userName = document.getElementById("name").value;
            if (userName != null && userName != "" && isAlphaNumeric(userName)) {
                // Check if user name already exists

                // If user name does not exist, add user
                var users = document.getElementById("users-select");
                var newUser = document.createElement("div");
                newUser.className = "user";
                newUser.innerHTML = "<span>" + userName + "</span>";
                console.log(newUser);
                console.log(users);
                users.appendChild(newUser);
                closeWindow();
            }
            else{
                alert("Invalid username");
            }
        }

        function closeWindow(){
            var new_channel_window = document.getElementById("create-new-window");
            new_channel_window.style.display = "none";
            var disable_content = document.getElementById("disable");
            disable_content.style.opacity = "1";
            disable_content.style.pointerEvents = "auto";
        }

        function getChannels() {
            console.log("getChannels called");
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("channel-select").innerHTML = this.responseText;
                }
            };
            // TODO: Set str to query discussion id
            // str = 
            xmlhttp.open("GET", "getChannels.php?q=" + str, true);
            xmlhttp.send();
        }





        
        //THIS IS THE AJAX TO CREATE A CHANNEL

        // SET THESE TO YOUR VALUES
        var name_input = 'TESTNAME';
        var board_id = '70';

        var xhr_create = new XMLHttpRequest();
        xhr_create.onreadystatechange = function() {
            if(xhr_create.readyState == 4 && xhr_create.status == 200) {
                if(this.responseText == "TRUE") {
                    // FETCH/RELOAD THE CHANNEL LIST HERE
                }
            }
        }
        xhr_create.open('POST', '/create-channel', false);
        xhr_create.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xhr_create.send('boardId='+board_id+'&name='+name_input);


        
        //THIS IS THE AJAX TO FETCH THE CHANNELS
        
        // SET THESE TO YOUR VALUES
        var board_id = '70';

        var xhr_fetch = new XMLHttpRequest();
        xhr_fetch.onreadystatechange = function() {
            if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                // DO/CALL YOUR RENDER FROM IN HERE
                console.log(this.responseText);
            }
        }
        xhr_fetch.open('POST', '/fetch-channels-list', false);
        xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr_fetch.send('boardId='+board_id);

        



        //THIS IS THE AJAX TO CREATE A MESSAGE

        // SET THESE TO YOUR VALUES
        var message = 'TESTMESSAGE';
        var channel_id = '5';

        var xhr_create = new XMLHttpRequest();
        xhr_create.onreadystatechange = function() {
            if(xhr_create.readyState == 4 && xhr_create.status == 200) {
                if(this.responseText == "TRUE") {
                    // FETCH/RELOAD THE MESSAGE LIST HERE
                }
            }
        }
        xhr_create.open('POST', '/create-message', false);
        xhr_create.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xhr_create.send('channelId='+channel_id+'&message='+message);


        
        //THIS IS THE AJAX TO FETCH THE MESSAGES
        
        // SET THESE TO YOUR VALUES
        var channel_id = '5';

        var xhr_fetch = new XMLHttpRequest();
        xhr_fetch.onreadystatechange = function() {
            if(xhr_fetch.readyState == 4 && xhr_fetch.status == 200) {
                // DO/CALL YOUR RENDER FROM IN HERE
                console.log(this.responseText);
            }
        }
        xhr_fetch.open('POST', '/fetch-messages-list', false);
        xhr_fetch.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr_fetch.send('channelId='+channel_id);
    </script>
</body>